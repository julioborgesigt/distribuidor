<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <!-- Meta tag responsiva -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Página do Administrador</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <!-- Biblioteca ProgressBar.js -->
  <script src="https://cdn.jsdelivr.net/npm/progressbar.js"></script>
  <style>
    /* Container principal para os formulários */
    .form-container {
      display: flex;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 10px;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
   
    /* Container pequeno estilizado */
    .small-container {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 10px;
      flex: 1;
      min-width: 280px;
      max-width: 320px;
    }

    /* Container vertical para agrupar itens */
    .vertical-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex: 1;
      min-width: 280px;
      max-width: 320px;
    }

    /* Container para filtros, gráficos e tabela */
    .auto-container {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 20px;
    }
    .auto-container h3 {
      font-size: 18px;
      margin-bottom: 15px;
      text-align: center;
    }

    /* Tabela: layout automático */
    .table {
      table-layout: auto;
      width: 100%;
    }
    .table th, .table td {
      white-space: normal;
      word-wrap: break-word;
    }
    /* Limitar a largura da coluna "Assunto" */
    .table th.assunto, .table td.assunto {
      max-width: 150px;
    }

    /* Container para os gráficos */
    .chart-container {
      display: flex;
      gap: 20px;
      justify-content: flex-start;
      align-items: flex-start;
      flex-wrap: wrap;
      max-width: 650px;
      align-items: center;
    }
   


    .chart-group {
      flex: 1;
      min-width: 120px;
      padding: 1% 3%;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    .chart-circle {
      display: inline-block;
      position: relative;
      padding: 5px;
    }


    /* Loader de carregamento */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsividade: ocultar colunas com a classe hide-mobile */
    @media (max-width: 768px) {
      .hide-mobile {
        display: none !important;
      }
      .table th, .table td {
        padding: 8px !important;
      }
    }
  </style>
</head>
<body class="p-3">
  <div class="container">
    <h1>Página do Administrador</h1>

    <!-- Loader de Carregamento -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
      <div class="loader"></div>
    </div>

    <!-- Formulários agrupados em container flex -->
    <div class="form-container">
      <!-- Pré-Cadastro de Usuário -->
      <div class="small-container">
        <h3>Pré-Cadastro</h3>
        <form id="preCadastroForm">
          <div class="mb-2">
            <label for="matricula" class="form-label">Matrícula</label>
            <input type="text" class="form-control" id="matricula" name="matricula" maxlength="8" required>
          </div>
          <div class="mb-2">
            <label for="nome" class="form-label">Nome</label>
            <input type="text" class="form-control" id="nome" name="nome" required>
          </div>
          <div class="mb-2">
            <label for="senha" class="form-label">Senha</label>
            <input type="password" class="form-control" id="senha" name="senha" required>
          </div>
          <button type="submit" class="btn btn-success w-100">Cadastrar</button>
        </form>
      </div>

      <!-- Atualizar Lista e Reset de Senha -->
      <div class="vertical-container">
        <div class="small-container">
          <h3>Atualizar Lista</h3>
          <form id="csvUploadForm" enctype="multipart/form-data">
            <div class="mb-2">
              <label for="csvFile" class="form-label">Planilha CSV</label>
              <input type="file" class="form-control" id="csvFile" name="csvFile" accept=".csv" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Upload</button>
          </form>
        </div>
        <div class="small-container">
          <h3>Reset de Senha</h3>
          <form id="resetPasswordForm">
            <div class="mb-2">
              <label for="matriculaReset" class="form-label">Matrícula</label>
              <input type="text" class="form-control" id="matriculaReset" name="matriculaReset" required>
            </div>
            <button type="submit" class="btn btn-warning w-100">Resetar</button>
          </form>
        </div>
      </div>
      
      <!-- Container para gráficos -->
      <div class="chart-container" id="chartContainer">
        <div class="chart-group">
          <h4>Estatísticas</h4>
          <div class="chart-row" id="statsRow">
            <!-- Gráficos serão inseridos aqui -->
          </div>
        </div>
      </div>
    </div>

    <!-- Container para filtros e ações -->
    <div class="auto-container">
      <h2>Filtros e ações</h2>
      <div class="row g-2">
        <div class="col-md-2">
          <label for="filtroClasse" class="form-label">Classe</label>
          <select id="filtroClasse" class="form-select">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="filtroAssunto" class="form-label">Assunto</label>
          <select id="filtroAssunto" class="form-select">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-md-1">
          <label for="filtroTarjas" class="form-label">Tarjas</label>
          <select id="filtroTarjas" class="form-select">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-md-1">
          <label for="filtroUsuario" class="form-label">Usuário</label>
          <select id="filtroUsuario" class="form-select">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-md-1">
          <label for="ordenarPrazo" class="form-label">P. P.</label>
          <select id="ordenarPrazo" class="form-select">
            <option value="">Selecione</option>
            <option value="asc">Crescente</option>
            <option value="desc">Decrescente</option>
          </select>
        </div>
        <div class="col-md-1">
          <label for="ordenarData" class="form-label">Dt. Int.</label>
          <select id="ordenarData" class="form-select">
            <option value="">Selecione</option>
            <option value="asc">Crescente</option>
            <option value="desc">Decrescente</option>
          </select>
        </div>
        <div class="col-md-1">
          <label for="ordenarDias" class="form-label">Dias R.</label>
          <select id="ordenarDias" class="form-select">
            <option value="">Selecione</option>
            <option value="asc">Crescente</option>
            <option value="desc">Decrescente</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="buscaProcesso" class="form-label">Busca por Nº P.</label>
          <input type="text" id="buscaProcesso" class="form-control" placeholder="0030218-07.2011.8.06.0091">
        </div>
      </div>
      <div class="row g-2 align-items-center mt-3">
        <div class="col-md-2">
          <label for="bulkMatricula" class="form-label">Para atribuir selecione 1 ou mais processos:</label>
        </div>
        <div class="col-md-2">
          <input type="text" id="bulkMatricula" class="form-control" placeholder="Matrícula destino">
        </div>
        <div class="col-md-2">
          <button id="bulkAtribuirBtn" class="btn btn-primary me-2 w-100">Atribuir</button>
        </div>
        <div class="col-md-2">
          <button id="bulkExcluirBtn" class="btn btn-danger me-2 w-100">Excluir sel.</button>
        </div>
        <div class="col-md-2">
          <button id="bulkCumpridoBtn" class="btn btn-success w-100">Cumprir sel.</button>
        </div>
      </div>
    </div>

    <!-- Container para a tabela -->
    <div class="auto-container">
      <h2>Lista Geral Atualizada</h2>
      <div class="table-responsive">
        <table class="table table-bordered" id="processTable">
          <thead class="table-light">
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>Número do Processo</th>
              <th class="hide-mobile">Prazo P.</th>
              <th class="hide-mobile">Classe Principal</th>
              <!-- Aqui, adicione a classe 'assunto' tanto para o th quanto para os tds -->
              <th class="hide-mobile assunto">Assunto</th>
              <th>Tarjas</th>
              <th class="hide-mobile">Data Int.</th>
              <th>Usuário</th>
              <th>Dias praz.</th>
              <th>Nº Intim.</th>
              <th class="hide-mobile">Cump.</th>
              <th class="hide-mobile">Atribuir Matricula.</th>
            </tr>
          </thead>
          <tbody>
            <!-- As linhas serão inseridas via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div> <!-- Fim do container principal -->

  <!-- Bootstrap JS (Popper incluso) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Variáveis globais para armazenar processos
    let allProcesses = [];
    let filteredProcesses = [];

    // Função para criar um progress ring usando ProgressBar.js
    function createChartCircle(label, percentage, count) {
    // Calcula o tamanho conforme a largura da tela
    const size =  window.innerWidth < 400 ? 90 : (window.innerWidth > 400 && window.innerWidth < 768) ? 100 : window.innerWidth >= 768 ? 100 : 100;
    const strokeWidth = 8;
    var wrapper = document.createElement("div");
    wrapper.className = "chart-circle";
    wrapper.style.width = size + "px";
    wrapper.style.height = size + "px";
    wrapper.style.position = "relative";

    var progressContainer = document.createElement("div");
    progressContainer.style.width = "100%";
    progressContainer.style.height = "100%";
    wrapper.appendChild(progressContainer);

    setTimeout(function() {
      var circle = new ProgressBar.Circle(progressContainer, {
        color: '#007bff',
        strokeWidth: strokeWidth,
        trailWidth: strokeWidth,
        trailColor: '#eee',
        easing: 'easeInOut',
        duration: 1400,
        text: {
          autoStyleContainer: false
        },
        from: { color: '#aaa', width: strokeWidth },
        to: { color: '#007bff', width: strokeWidth },
        step: function(state, circleInstance) {
          circleInstance.setText("<strong>" + label + "</strong><br>" + count + "<br>(" + Math.round(circleInstance.value() * 100) + "%)");
        }
      });
      // Ajusta a fonte proporcional ao tamanho do círculo
      circle.text.style.fontFamily = '"Arial", sans-serif';
      circle.text.style.fontSize = (size / 8) + "px";
      circle.animate(percentage / 100);
    }, 10);

    return wrapper;
  }



    // Função para calcular dias restantes
    function calcDias(proc) {
      if (!proc.data_intimacao) return 0;
      const dataIntimacao = new Date(proc.data_intimacao);
      const prazoMatch = proc.prazo_processual ? proc.prazo_processual.match(/(\d+)/) : null;
      const prazoDias = prazoMatch ? parseInt(prazoMatch[1]) : 0;
      const prazoDate = new Date(dataIntimacao);
      prazoDate.setDate(prazoDate.getDate() + prazoDias);
      const diff = prazoDate - new Date();
      return Math.ceil(diff / (1000 * 60 * 60 * 24));
    }

    // Função para atualizar os gráficos
    function updateCharts() {
      const container = document.getElementById('statsRow'); // Container dos gráficos
      container.innerHTML = ''; // Limpa os gráficos

      const total = allProcesses.length;
      container.appendChild(createChartCircle('TOTAL', 100, total));

      const userCounts = {};
      allProcesses.forEach(proc => {
        if (proc.User && proc.User.nome) {
          const name = proc.User.nome;
          userCounts[name] = (userCounts[name] || 0) + 1;
        }
      });

      Object.entries(userCounts).forEach(([name, count]) => {
        const abbrev = name.substring(0, 8);
        const percentage = (count / total) * 100;
        container.appendChild(createChartCircle(abbrev, percentage, count));
      });

      let overdue = 0, urgent = 0, upcoming = 0, preso = 0, homicid = 0, furtos = 0, roubos = 0;
      allProcesses.forEach(proc => {
        const dias = proc.data_intimacao ? calcDias(proc) : 0;
        if (dias <= 0) {
          overdue++;
        } else if (dias < 10) {
          urgent++;
        } else if (dias < 30) {
          upcoming++;
        }
        if (proc.tarjas && proc.tarjas.trim().toLowerCase().includes('réu preso')) {
          preso++;
        }
        if (proc.assunto_principal &&
            ['homicídio qualificado', 'homicídio simples', 'homicídio culposo']
            .some(h => proc.assunto_principal.trim().toLowerCase().includes(h))) {
          homicid++;
        }
        if (proc.assunto_principal &&
            ['roubo', 'roubo qualificado']
            .some(h => proc.assunto_principal.trim().toLowerCase().includes(h))) {
          roubos++;
        }
        if (proc.assunto_principal &&
            ['furto', 'furto qualificado']
            .some(h => proc.assunto_principal.trim().toLowerCase().includes(h))) {
          furtos++;
        }
      });

      container.appendChild(createChartCircle('Vencidos', (overdue / total) * 100, overdue));
      container.appendChild(createChartCircle('P < 10d', (urgent / total) * 100, urgent));
      container.appendChild(createChartCircle('P < 30d', (upcoming / total) * 100, upcoming));
      container.appendChild(createChartCircle('R.Preso', (preso / total) * 100, preso));
      container.appendChild(createChartCircle('Homic.', (homicid / total) * 100, homicid));
      container.appendChild(createChartCircle('Roubos', (roubos / total) * 100, roubos));
      container.appendChild(createChartCircle('Furtos', (furtos / total) * 100, furtos));
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchProcesses();
      document.getElementById('filtroClasse').addEventListener('change', filterAndRenderTable);
      document.getElementById('filtroAssunto').addEventListener('change', filterAndRenderTable);
      document.getElementById('filtroTarjas').addEventListener('change', filterAndRenderTable);
      document.getElementById('filtroUsuario').addEventListener('change', filterAndRenderTable);
      document.getElementById('ordenarPrazo').addEventListener('change', filterAndRenderTable);
      document.getElementById('ordenarData').addEventListener('change', filterAndRenderTable);
      document.getElementById('ordenarDias').addEventListener('change', filterAndRenderTable);

      document.getElementById('select-all').addEventListener('change', (e) => {
        const checked = e.target.checked;
        document.querySelectorAll('.bulk-checkbox').forEach(cb => {
          cb.checked = checked;
        });
      });

      document.getElementById('buscaProcesso').addEventListener('input', function(e) {
        let digits = this.value.replace(/\D/g, '').substring(0,20);
        let formatted = '';
        if (digits.length > 0) {
          formatted = digits.substring(0,7);
        }
        if (digits.length > 7) {
          formatted += '-' + digits.substring(7,9);
        }
        if (digits.length > 9) {
          formatted += '.' + digits.substring(9,13);
        }
        if (digits.length > 13) {
          formatted += '.' + digits.substring(13,14);
        }
        if (digits.length > 14) {
          formatted += '.' + digits.substring(14,16);
        }
        if (digits.length > 16) {
          formatted += '.' + digits.substring(16,20);
        }
        this.value = formatted;
        
        const searchValue = formatted;
        if (searchValue) {
          const searchFiltered = allProcesses.filter(proc => proc.numero_processo.includes(searchValue));
          renderTable(searchFiltered);
          updateCharts();
        } else {
          filterAndRenderTable();
          updateCharts();
        }
      });
    });

    function fetchProcesses() {
      fetch('/admin/processes')
        .then(res => res.json())
        .then(data => {
          allProcesses = data;
          updateFilters();
          filterAndRenderTable();
          updateCharts();
        })
        .catch(err => console.error(err));
    }

    function updateFilters() {
      const filtroClasse = document.getElementById('filtroClasse');
      const filtroAssunto = document.getElementById('filtroAssunto');
      const filtroTarjas = document.getElementById('filtroTarjas');
      const filtroUsuario = document.getElementById('filtroUsuario');

      filtroClasse.innerHTML = '<option value="">Todos</option>';
      filtroAssunto.innerHTML = '<option value="">Todos</option>';
      filtroTarjas.innerHTML = '<option value="">Todos</option>';
      filtroUsuario.innerHTML = '<option value="">Todos</option>';

      const classes = new Set();
      const assuntos = new Set();
      const tarjasSet = new Set();
      const usuarios = new Set();

      allProcesses.forEach(proc => {
        if (proc.classe_principal) classes.add(proc.classe_principal);
        if (proc.assunto_principal) assuntos.add(proc.assunto_principal);
        if (proc.tarjas) tarjasSet.add(proc.tarjas);
        if (proc.User && proc.User.nome) usuarios.add(proc.User.nome);
      });

      classes.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        filtroClasse.appendChild(option);
      });
      assuntos.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        filtroAssunto.appendChild(option);
      });
      tarjasSet.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        filtroTarjas.appendChild(option);
      });
      usuarios.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        filtroUsuario.appendChild(option);
      });
    }

    function filterAndRenderTable() {
      const filtroClasse = document.getElementById('filtroClasse').value;
      const filtroAssunto = document.getElementById('filtroAssunto').value;
      const filtroTarjas = document.getElementById('filtroTarjas').value;
      const filtroUsuario = document.getElementById('filtroUsuario').value;
      const ordenarPrazo = document.getElementById('ordenarPrazo').value;
      const ordenarData = document.getElementById('ordenarData').value;
      const ordenarDias = document.getElementById('ordenarDias').value;

      filteredProcesses = allProcesses.filter(proc => {
        let match = true;
        if (filtroClasse && proc.classe_principal !== filtroClasse) match = false;
        if (filtroAssunto && proc.assunto_principal !== filtroAssunto) match = false;
        if (filtroTarjas && proc.tarjas !== filtroTarjas) match = false;
        if (filtroUsuario) {
          const userName = proc.User ? proc.User.nome : 'nenhum';
          if (userName !== filtroUsuario) match = false;
        }
        return match;
      });

      if (ordenarPrazo) {
        filteredProcesses.sort((a, b) => {
          const aPrazo = parseInt(a.prazo_processual) || 0;
          const bPrazo = parseInt(b.prazo_processual) || 0;
          return ordenarPrazo === 'asc' ? aPrazo - bPrazo : bPrazo - aPrazo;
        });
      }

      if (ordenarData) {
        filteredProcesses.sort((a, b) => {
          const aDate = new Date(a.data_intimacao);
          const bDate = new Date(b.data_intimacao);
          return ordenarData === 'asc' ? aDate - bDate : bDate - aDate;
        });
      }

      if (ordenarDias) {
        filteredProcesses.sort((a, b) => {
          const calcDias = proc => {
            if (!proc.data_intimacao) return 0;
            const dataIntimacao = new Date(proc.data_intimacao);
            const prazoMatch = proc.prazo_processual ? proc.prazo_processual.match(/(\d+)/) : null;
            const prazoDias = prazoMatch ? parseInt(prazoMatch[1]) : 0;
            const prazoDate = new Date(dataIntimacao);
            prazoDate.setDate(prazoDate.getDate() + prazoDias);
            const diff = prazoDate - new Date();
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
          };

          const aDias = calcDias(a);
          const bDias = calcDias(b);
          return ordenarDias === 'asc' ? aDias - bDias : bDias - aDias;
        });
      }

      renderTable(filteredProcesses);
    }

    function renderTable(data) {
      const tbody = document.querySelector('#processTable tbody');
      tbody.innerHTML = '';
      data.forEach(proc => {
        const prazoMatch = proc.prazo_processual ? proc.prazo_processual.match(/(\d+)/) : null;
        const prazoDias = prazoMatch ? parseInt(prazoMatch[1]) : 0;
        let diasRestantes = 'N/A';
        if (proc.data_intimacao) {
          const dataIntimacao = new Date(proc.data_intimacao);
          const prazoDate = new Date(dataIntimacao);
          prazoDate.setDate(prazoDate.getDate() + prazoDias);
          const diff = prazoDate - new Date();
          diasRestantes = Math.ceil(diff / (1000 * 60 * 60 * 24));
        }
        const userName = proc.User ? proc.User.nome : 'nenhum';
        const reiteracoes = proc.reiteracoes || 0;
        const statusCumprido = proc.cumprido ? 'sim' : 'não';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="bulk-checkbox" data-id="${proc.id}"></td>
          <td>${proc.numero_processo}</td>
          <td class="hide-mobile">${proc.prazo_processual || ''}</td>
          <td class="hide-mobile">${proc.classe_principal || ''}</td>
          <!-- Adicione a classe "assunto" aqui -->
          <td class="hide-mobile assunto">${proc.assunto_principal || ''}</td>
          <td>${proc.tarjas || ''}</td>
          <td class="hide-mobile">${proc.data_intimacao || ''}</td>
          <td>${userName}</td>
          <td>${diasRestantes}</td>
          <td>${reiteracoes}</td>
          <td class="hide-mobile">${statusCumprido}</td>
          <td class="hide-mobile">
            <form class="manual-assign-form">
              <input type="hidden" name="numeroProcesso" value="${proc.numero_processo}">
              <input type="text" class="form-control form-control-sm mb-2" name="matricula" placeholder="Matrícula" required>
              <button type="submit" class="btn btn-sm btn-primary">Atribuir</button>
            </form>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll('.manual-assign-form').forEach(form => {
        form.addEventListener('submit', e => {
          e.preventDefault();
          const formData = new FormData(form);
          const data = {
            numeroProcesso: formData.get('numeroProcesso'),
            matricula: formData.get('matricula')
          };
          fetch('/admin/manual-assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          })
          .then(res => res.text())
          .then(msg => {
            alert(msg);
            fetchProcesses();
          })
          .catch(err => console.error(err));
        });
      });
    }

    // Upload de CSV
    const csvUploadForm = document.getElementById('csvUploadForm');
    document.getElementById('csvUploadForm').addEventListener('submit', function(e) {
      e.preventDefault();
      document.getElementById('loading-overlay').style.display = 'flex';
      const formData = new FormData(this);
      fetch('/admin/upload', {
        method: 'POST',
        body: formData
      })
      .then(res => res.text())
      .then(msg => {
        document.getElementById('loading-overlay').style.display = 'none';
        alert(msg);
        fetchProcesses();
      })
      .catch(err => {
        document.getElementById('loading-overlay').style.display = 'none';
        console.error('Erro ao enviar o arquivo:', err);
      });
    });

    // Pré-cadastro de usuário
    const preCadastroForm = document.getElementById('preCadastroForm');
    preCadastroForm.addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(preCadastroForm);
      const data = {
        matricula: formData.get('matricula'),
        nome: formData.get('nome'),
        senha: formData.get('senha')
      };
      fetch('/admin/pre-cadastro', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(msg => {
        alert(msg);
        preCadastroForm.reset();
      })
      .catch(err => console.error(err));
    });

    // Reset de senha
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    resetPasswordForm.addEventListener('submit', e => {
      e.preventDefault();
      const formData = new FormData(resetPasswordForm);
      const data = {
        matricula: formData.get('matriculaReset'),
        newPassword: formData.get('newPassword')
      };
      fetch('/admin/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(msg => {
        alert(msg);
        resetPasswordForm.reset();
      })
      .catch(err => console.error(err));
    });

    // Atribuição em massa
    document.getElementById('bulkAtribuirBtn').addEventListener('click', () => {
      const selectedIds = Array.from(document.querySelectorAll('.bulk-checkbox'))
        .filter(cb => cb.checked)
        .map(cb => cb.getAttribute('data-id'));
      const matriculaDestino = document.getElementById('bulkMatricula').value.trim();
      
      console.log('IDs selecionados para atribuição:', selectedIds);
      
      if (selectedIds.length === 0) {
        alert('Nenhum processo selecionado.');
        return;
      }
      if (!matriculaDestino) {
        alert('Digite a matrícula destino para a atribuição em massa.');
        return;
      }
      
      fetch('/admin/bulk-assign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ processIds: selectedIds, matricula: matriculaDestino })
      })
      .then(res => res.text())
      .then(msg => {
        alert(msg);
        fetchProcesses();
      })
      .catch(err => console.error('Erro no bulk-assign:', err));
    });

    // Exclusão em massa
    document.getElementById('bulkExcluirBtn').addEventListener('click', () => {
      const selectedIds = Array.from(document.querySelectorAll('.bulk-checkbox'))
        .filter(cb => cb.checked)
        .map(cb => cb.getAttribute('data-id'));
      
      console.log('IDs selecionados para exclusão:', selectedIds);
      
      if (selectedIds.length === 0) {
        alert('Nenhum processo selecionado.');
        return;
      }
      
      fetch('/admin/bulk-delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ processIds: selectedIds })
      })
      .then(res => res.text())
      .then(msg => {
        alert(msg);
        fetchProcesses();
      })
      .catch(err => console.error('Erro no bulk-delete:', err));
    });

    // Marcar como cumprido em massa
    document.getElementById('bulkCumpridoBtn').addEventListener('click', () => {
      const selectedIds = Array.from(document.querySelectorAll('.bulk-checkbox'))
        .filter(cb => cb.checked)
        .map(cb => cb.getAttribute('data-id'));
      
      console.log('IDs selecionados para marcar como cumprido:', selectedIds);
      
      if (selectedIds.length === 0) {
        alert('Nenhum processo selecionado.');
        return;
      }
      
      fetch('/admin/bulk-cumprido', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ processIds: selectedIds })
      })
      .then(res => res.text())
      .then(msg => {
        alert(msg);
        fetchProcesses();
      })
      .catch(err => console.error('Erro no bulk-cumprido:', err));
    });
  </script>
</body>
</html>
