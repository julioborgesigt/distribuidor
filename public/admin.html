<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <!-- Meta tag responsiva -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Página do Administrador</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- Biblioteca ProgressBar.js -->
  <script src="https://cdn.jsdelivr.net/npm/progressbar.js"></script>
  <link rel="stylesheet" href="css/style.css">

</head>
<body class="p-3">
  <div class="container">




    
    
    
    
    
  
    


    <!-- Loader de Carregamento -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
      <div class="loader"></div>
    </div>

    <!-- Formulários agrupados em container flex -->
    <div class="form-container">
      <!-- Pré-Cadastro de Usuário -->
      <!-- Disparador (apenas visível em dispositivos móveis) 
      <div class="d-block d-md-none mb-2" id="preCadastroContainerMobile">
        <a class="btn btn-secondary w-100 d-flex align-items-center justify-content-between" data-bs-toggle="collapse" href="#preCadastroCollapse" role="button" aria-expanded="false" aria-controls="preCadastroCollapse">
          <span>Pré-Cadastro</span>
          <i class="bi bi-chevron-down"></i>
        </a>
        
      </div>
      
      
      

      <!-- Área do pré-cadastro -->
      
      <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
          <button id="darkModeToggle" class="btn toggle-btn" aria-label="Alternar modo escuro">
            <i id="sunIcon" class="bi bi-sun-fill"></i>
            <i id="moonIcon" class="bi bi-moon-fill" style="display: none;"></i>
          </button>
          <h4>Gerenciador</h4>
          <button id="logoutBtn" class="btn logout-btn" title="Logout">
            <i class="bi bi-power"></i>
          </button>
        </div>
      </div>





      <div class="chart-container">


      <div class="small-container" id="preCadastroContainer">
        <h4>Pré-Cadastro</h4>
        <form id="preCadastroForm">
          <div class="mb-2">
            <label for="matricula" class="form-label">Matrícula</label>
            <input type="text" class="form-control" id="matricula" name="matricula" maxlength="8" minlength="8" required>
          </div>
          <div class="mb-2">
            <label for="nome" class="form-label">Nome</label>
            <input type="text" class="form-control" id="nome" name="nome" required>
          </div>
          <div class="mb-2">
            <label for="senha" class="form-label">Senha</label>
            <input type="password" class="form-control" id="senha" name="senha" maxlength="8" minlength="8" required>
          </div>
          <!-- Novo seletor para tipo de cadastro -->
          <div class="mb-2">
            <label for="tipoCadastro" class="form-label">Tipo de Cadastro</label>
            <select class="form-select" id="tipoCadastro" name="tipoCadastro" required>
              <option value="admin_padrao">Administrador Padrão</option>
              <option value="admin_super">Administrador Super</option>
            </select>
          </div>
          <button type="submit" class="btn btn-success w-100 mt-1">Cadastrar</button>
        </form>
      </div>
   



      <!-- Atualizar Lista e Reset de Senha -->
      <div class="vertical-container" id="atualizarListaContainer">
      
        <div class="small-container">
          <h4>Atualizar Lista</h4>
          <form id="csvUploadForm" enctype="multipart/form-data">
            <div class="mb-2">
              <label for="csvFile" class="form-label">Planilha CSV</label>
              <input type="file" class="form-control" id="csvFile" name="csvFile" accept=".csv" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Upload</button>
          </form>
        </div>


        <div class="small-container" id="resetApagarUsuarioContainer">
          <h5>Reset / Apagar Usuário</h5>
          <form id="userActionForm">
            <div class="mb-2">
              <label for="matriculaAction" class="form-label">Matrícula</label>
              <input type="text" class="form-control" id="matriculaAction" name="matriculaAction" maxlength="8" minlength="8" required>
            </div>
            <div class="d-flex flex-column gap-2">
              <button type="button" id="resetPasswordBtn" class="btn btn-warning">Resetar Senha</button>
              <button type="button" id="deleteUserBtn" class="btn btn-danger">Apagar Usuário</button>
            </div>
          </form>
        </div>      
        
    </div>
      
    <!-- Container para gráficos -->
      
     

        
    <div class="chart-group">
            

      <div class="chart-header">
              
        <h4>Estatísticas</h4>
           
      
        <div class="chart-toggle-container">
          <span class="toggle-text">Todos</span>
            <label class="switch">
              <input type="checkbox" id="chartToggle">
                <span class="slider"></span>
            </label>
              <span class="toggle-text">Cumpridos(30d)</span>
        </div>
              
      </div> 
            

      <div class="chart-row" id="statsRow">
          <!-- Gráficos serão inseridos aqui -->
      </div>

    </div>


  </div> 




  

    <!-- Container para filtros e ações -->
    <div class="auto-container">
      <h2>Filtros</h2>
      <div class="row g-2">
        <!-- Linha 1 -->
        <div class="col-6 col-md-3">
          <label for="filtroClasse" class="form-label">Classe</label>
          <select id="filtroClasse" class="form-select">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="filtroAssunto" class="form-label">Assunto</label>
          <select id="filtroAssunto" class="form-select">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="filtroTarjas" class="form-label">Tarjas</label>
          <select id="filtroTarjas" class="form-select">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="filtroUsuario" class="form-label">Usuário</label>
          <select id="filtroUsuario" class="form-select">
            <option value="">Todos</option>
          </select>
        </div>
        <!-- Força quebra de linha em md (>=768px) e oculta em lg (≥992px) -->
        <div class="w-100 d-none d-md-block d-lg-none"></div>
        <!-- Linha 2 -->
        <div class="col-6 col-md-3">
          <label for="ordenarPrazo" class="form-label">Prazo concedido</label>
          <select id="ordenarPrazo" class="form-select">
            <option value="">Selecione</option>
            <option value="asc">Crescente</option>
            <option value="desc">Decrescente</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="ordenarData" class="form-label">Data da Intm.</label>
          <select id="ordenarData" class="form-select">
            <option value="">Selecione</option>
            <option value="asc">Crescente</option>
            <option value="desc">Decrescente</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="ordenarDias" class="form-label">Prazo Restante</label>
          <select id="ordenarDias" class="form-select">
            <option value="">Selecione</option>
            <option value="asc">Crescente</option>
            <option value="desc">Decrescente</option>
          </select>
        </div>
        <!-- Força nova quebra após o 6º filtro -->
        <div class="w-100 d-none d-md-block d-lg-none"></div>
        <!-- Linha 3 -->
        
        <div class="col-6 col-md-3">
          <label for="ordenarIntim" class="form-label">Nº Intimações</label>
          <select id="ordenarIntim" class="form-select">
            <option value="">Selecione</option>
            <option value="asc">Crescente</option>
            <option value="desc">Decrescente</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="filtroCumprido" class="form-label">Cumprido?</label>
          <select id="filtroCumprido" class="form-select">
            <option value="nao" selected>Não cumprido</option>
            <option value="sim">Cumprido</option>
            <option value="">Todos</option>
          </select>
        </div>
        <div class="col-6 col-md-3">
          <label for="buscaProcesso" class="form-label">Busca por Nº P.</label>
          <input type="text" id="buscaProcesso" class="form-control" placeholder="xxxxxxx-xx.xxxx.x.xx.xxxx">
        </div>
      </div>
      
      
    </div>


    <!-- Área de Ações em Massa -->
    <div class="auto-container" id="acoesEmMassa">
      <h2>Ações em massa</h2>
      <div class="row g-2 align-items-center mt-3">
        <!-- Campo de matrícula (clicável) -->
        <div class="col-md-3">
          <!-- Você pode substituir o input por um botão ou manter o input com um evento onfocus/click -->
          <input type="text" id="bulkMatricula" class="form-control" placeholder="Selecione Mat. dest. (clique aqui)" maxlength="8" minlength="8" readonly>
        </div>
        <div class="col-md-3">
          <button id="bulkAtribuirBtn" class="btn btn-primary me-2 w-100">Atribuir sel. à Mat.</button>
        </div>
        <div class="col-md-3">
          <button id="bulkExcluirBtn" class="btn btn-danger me-2 w-100">Excluir p. selec.</button>
        </div>
        <div class="col-md-3">
          <button id="bulkCumpridoBtn" class="btn btn-success me-2 w-100">Cumprir p. selec.</button>
        </div>
      </div>
    </div>

    <!-- Offcanvas para seleção de usuário -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="userListOffcanvas" aria-labelledby="userListOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 id="userListOffcanvasLabel">Selecione um Usuário</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
      </div>
      <div class="offcanvas-body">
        <!-- Container para a lista de usuários -->
        <div class="list-group" id="userListContainer">
          <!-- Os itens serão adicionados via JavaScript -->
          <!-- Exemplo de item:
          <button type="button" class="list-group-item list-group-item-action" data-matricula="12345678">
            12345678 - João Silva
          </button>
          -->
        </div>
      </div>
    </div>

    <!-- Container para a tabela -->
    <div class="auto-container">
      <h2>Lista Geral Atualizada</h2>
      <div class="print-buttons d-flex align-items-center justify-content-start col-md-6 mt-3 mb-3">
        <button id="printAllBtn" class="btn btn-primary me-2 w-50">Imprimir Todos</button>
        <button id="printSelectedBtn" class="btn btn-primary w-50">Imprimir Selecionados</button>
      </div>
      
      <div class="table-responsive">
        <table class="table table-bordered" id="processTable">
          <thead class="table-light">
            <tr>
              <th><input type="checkbox" id="select-all"></th>
              <th>Número do Processo</th>
              <th class="hide-mobile">Prazo Conc.</th>
              <th class="hide-mobile">Classe Principal</th>
              <!-- Aqui, adicione a classe 'assunto' tanto para o th quanto para os tds -->
              <th class="hide-mobile assunto">Assunto</th>
              <th>Tarjas</th>
              <th class="hide-mobile">Data Int.</th>
              <th>Usuário</th>
              <th>Prazo Rest.</th>
              <th class="nDEintimacoes">Nº de Intim.</th>
              <th class="hide-mobile statuscumprido">Cumprido?</th>
              <th>Observações (Clique Duplo)</th>
              <th class="cumprido-checkbox">Dar. Cump.</th>
            </tr>
          </thead>
          <tbody>
            <!-- As linhas serão inseridas via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>


    
  
  </div>

  <!-- Bootstrap JS (Popper incluso) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script src="/js/script.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/';
        return;
      }
      
     

      
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('token'); 
        localStorage.removeItem('userInfo');
        window.location.href = '/';
      });


      document.addEventListener('DOMContentLoaded', () => {
      // Recupera os dados do usuário armazenados após o login
      const userInfo = JSON.parse(localStorage.getItem('userInfo'));
     
      const chartGroup = document.querySelector('.chart-group');
      if (userInfo) {
        if (userInfo.admin_super) {
          chartGroup.classList.add('admin-super');
        } else if (userInfo.admin_padrao) {
          chartGroup.classList.add('admin-padrao');
        }
      }


      // Se o usuário existe e for admin_padrao (mas NÃO admin_super)
      if (userInfo && userInfo.admin_padrao && !userInfo.admin_super) {
        // Desabilitar os filtros de "Usuário" e "Cumprido"
        const filtroUsuario = document.getElementById('filtroUsuario');
        const filtroCumprido = document.getElementById('filtroCumprido');
        if (filtroUsuario) filtroUsuario.disabled = true;
        if (filtroCumprido) filtroCumprido.disabled = true;

        // Desabilitar os botões de Ações em massa 
        const bulkMatricula = document.getElementById('bulkMatricula');
        const bulkAtribuirBtn = document.getElementById('bulkAtribuirBtn');
        const bulkExcluirBtn = document.getElementById('bulkExcluirBtn');
        const bulkCumpridoBtn = document.getElementById('bulkCumpridoBtn');
        if (bulkMatricula) bulkMatricula.disabled = true;
        if (bulkAtribuirBtn) bulkAtribuirBtn.disabled = true;
        if (bulkExcluirBtn) bulkExcluirBtn.disabled = true;
        if (bulkCumpridoBtn) bulkCumpridoBtn.disabled = true;

        // Desabilitar funcionalidades de Pré-Cadastro, Atualizar Lista e Reset/Apagar Usuário

        // Pré-Cadastro
        const preCadastroInputs = document.querySelectorAll('#preCadastroForm input, #preCadastroForm button, #preCadastroForm select');
        preCadastroInputs.forEach(el => el.disabled = true);

        // Atualizar Lista (Upload CSV)
        const csvInputs = document.querySelectorAll('#csvUploadForm input, #csvUploadForm button, #csvUploadForm select');
        csvInputs.forEach(el => el.disabled = true);

        // Reset / Apagar Usuário
        const userActionInputs = document.querySelectorAll('#userActionForm input, #userActionForm button, #userActionForm select');
        userActionInputs.forEach(el => el.disabled = true);

        const acoesContainer = document.getElementById('acoesEmMassa');
        if (acoesContainer) {
          acoesContainer.style.display = 'none'; // Oculta completamente
        }
          
        
        const preCadastroContainer = document.getElementById('preCadastroContainer');
        const atualizarListaContainer = document.getElementById('atualizarListaContainer');
        const resetApagarContainer = document.getElementById('resetApagarUsuarioContainer');
        
        
        if (preCadastroContainer) preCadastroContainer.style.display = 'none';
        if (atualizarListaContainer) atualizarListaContainer.style.display = 'none';
        if (resetApagarContainer) resetApagarContainer.style.display = 'none';

        
        

      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      // Delegação de eventos para editar as células de observações
      document.querySelector('#processTable tbody').addEventListener('dblclick', function(e) {
        // Procura o elemento clicado (ou seu ancestral) que possua a classe "observacoes-cell"
        const cell = e.target.closest('.observacoes-cell');
        if (!cell) return; // Se não for célula de observações, sai

        // Evita que se adicione outro input se já houver um
        if (cell.querySelector('input')) return;

        const originalText = cell.innerText;
        const processId = cell.getAttribute('data-process-id');

        // Cria um input de texto limitado a 50 caracteres
        const input = document.createElement('input');
        input.type = 'text';
        input.value = originalText;
        input.maxLength = 20;
        input.style.width = '100%'; // Ocupa toda a largura da célula

        // Substitui o conteúdo da célula pelo input e foca nele
        cell.innerText = '';
        cell.appendChild(input);
        input.focus();

        // Quando o input perder o foco, tenta salvar o novo valor
        input.addEventListener('blur', () => {
          const newText = input.value;
          // Se desejar, aqui você pode adicionar validação (por exemplo, não permitir string vazia)
          cell.innerText = newText;
          const token = localStorage.getItem('token');
          fetch('/update-observacoes', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ processId, observacoes: newText })
          })
          .then(res => res.text())
          .then(msg => console.log('Observações atualizadas:', msg))
          .catch(err => {
            console.error('Erro ao atualizar observações:', err);
            // Em caso de erro, reverte para o valor original
            cell.innerText = originalText;
          });
        });
      });

    });


  </script>
</body>
</html>
